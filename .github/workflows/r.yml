name: CRAN → GitHub sync (AID)

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * *'  # Her gün UTC 03:00’te kontrol eder

permissions:
  contents: write

jobs:
  sync_from_cran:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Read package name and local version from DESCRIPTION
        id: local_info
        run: |
          pkg_name=$(Rscript -e "desc <- read.dcf('DESCRIPTION'); cat(desc[1,'Package'])")
          pkg_ver=$(Rscript -e "desc <- read.dcf('DESCRIPTION'); cat(desc[1,'Version'])")
          echo "pkg_name=$pkg_name" >> $GITHUB_ENV
          echo "pkg_ver=$pkg_ver" >> $GITHUB_ENV
          echo "Local package: $pkg_name $pkg_ver"

      - name: Query CRAN for latest available version
        id: cran_info
        run: |
          Rscript -e "options(repos='https://cran.r-project.org'); ap <- available.packages(); pkg <- Sys.getenv('pkg_name'); if(!pkg %in% rownames(ap)) { cat('NOT_ON_CRAN') } else { cat(ap[pkg,'Version']) }" > cran_version.txt
          cran_version=$(cat cran_version.txt)
          echo "cran_version=$cran_version" >> $GITHUB_ENV
          echo "CRAN version: $cran_version"

      - name: Exit if package not on CRAN
        if: env.cran_version == 'NOT_ON_CRAN'
        run: |
          echo "Package is not currently on CRAN. Exiting."
          exit 0

      - name: Check whether CRAN version is newer
        id: compare
        run: |
          echo "local version = $pkg_ver"
          echo "cran version  = $cran_version"
          if [ "$cran_version" = "$pkg_ver" ]; then
            echo "equal=true" >> $GITHUB_OUTPUT
          else
            echo "equal=false" >> $GITHUB_OUTPUT
          fi

      - name: Download CRAN tarball (if newer)
        if: steps.compare.outputs.equal == 'false'
        run: |
          pkg="$pkg_name"
          ver="$cran_version"
          tarball="${pkg}_${ver}.tar.gz"
          url="https://cran.r-project.org/src/contrib/${tarball}"
          echo "Downloading $url"
          wget -q --show-progress "$url" -O "$tarball" || { echo "Failed to download main src; try archive..."; exit 1; }
          mkdir -p /tmp/cranpkg
          tar -xzf "$tarball" -C /tmp/cranpkg
          extracted_dir=$(find /tmp/cranpkg -maxdepth 1 -type d -name "${pkg}*" | head -n1)
          if [ -z "$extracted_dir" ]; then
            echo "Extraction failed or directory not found"
            ls -la /tmp/cranpkg
            exit 1
          fi
          echo "Extracted to: $extracted_dir"
          rsync -av --delete --exclude='.git' "$extracted_dir"/ . || true
          echo "Files synchronized from CRAN tarball."

      - name: Commit & push changes (if any)
        if: steps.compare.outputs.equal == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: sync package from CRAN v${cran_version} [ci skip]"
            git push origin HEAD:main
          fi

      - name: Create tag for CRAN version
        if: steps.compare.outputs.equal == 'false'
        run: |
          tag="v${cran_version}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists."
          else
            git tag -a "$tag" -m "CRAN release ${cran_version}"
            git push origin "$tag"
          fi
